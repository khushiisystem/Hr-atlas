<ion-header [translucent]="true" mode="md" (click)="onMouseMove($event)">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button mode="md" fill="clear" [routerDirection]="'back'" (click)="goBack()" class="noBg noRipple">
        <ion-icon name="chevron-back-outline" aria-hidden="true" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title><span *ngIf="employee">{{employee.firstName | titlecase}} {{employee.lastName || '' | titlecase}}</span>
      <span *ngIf="!employee">Employee Attendance</span></ion-title>
    <div slot="end" class="ion-margin-end toggleview">
      <ion-button type="button" [fill]="showCalendar ? 'clear' : 'solid'" shape="round" mode="ios" color="tertiary" size="small" aria-label="List View" (click)="showCalendar = !showCalendar">
        <ion-icon aria-hidden="true" size="small" slot="icon-only" name="list"></ion-icon>
      </ion-button>
      <ion-button type="button" [fill]="!showCalendar ? 'clear' : 'solid'" shape="round" mode="ios" color="tertiary" size="small" aria-label="Calendar View" (click)="showCalendar = !showCalendar">
        <ion-icon aria-hidden="true" size="small" slot="icon-only" name="calendar"></ion-icon>
      </ion-button>
    </div>
    <!-- <ion-thumbnail slot="end" class="logo_img ion-margin-end">
      <ion-img src="../../../assets/icon/hr-atlas_logo_2.png" alt="HR-Atlas"></ion-img>
    </ion-thumbnail> -->
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" color="light" (click)="onMouseMove($event)">
  <ion-refresher slot="fixed" (ionRefresh)="handleRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <ion-modal [isOpen]="dateModal" [initialBreakpoint]="0.5" mode="md" [showBackdrop]="true" (didDismiss)="dateModal = false" #dateSelectModal>
    <ng-template>
      <ion-content>
        <ion-datetime presentation="month-year" size="cover" mode="md" #yearMonth [value]="attendanceDate" [max]="today.toISOString()" [min]="minDate.toISOString()" (ionChange)="selectDate($any($event));">
          <ion-label slot="title">Select Year and Month</ion-label>
          <ion-buttons slot="buttons">
            <ion-button mode="md" color="danger" (click)="yearMonth.cancel(); dateSelectModal.dismiss();">Cancel</ion-button>
            <ion-button mode="md" color="primary" (click)="yearMonth.confirm(); dateSelectModal.dismiss();">Done</ion-button>
          </ion-buttons>
        </ion-datetime>
      </ion-content>
    </ng-template>
  </ion-modal>

  <div *ngIf="showCalendar" class="calendarView">
    <ion-list inset="true" mode="ios">
      <ion-item detail="false" class="calendarControls">
        <ion-buttons slot="start">
          <ion-button color="tertiary" shape="round" fill="clear" strong="true" class="ion-no-margin" (click)="decrementYear()" aria-label="Previous Month">
            <img src="../../../assets/icon/left_arrows.svg" alt="Previous" width="30" height="30">
          </ion-button>
          <ion-button color="tertiary" shape="round" fill="clear" strong="true" class="ion-no-margin" (click)="decrementMonth()" aria-label="Next Year">
            <ion-icon slot="icon-only" name="chevron-back" aria-label="Previous Month"></ion-icon>
          </ion-button>
        </ion-buttons>
        <ion-label class="ion-text-center">{{ attendanceDate | date:"MMMM yyyy" }}</ion-label>
        <ion-buttons slot="end">
          <ion-button color="tertiary" shape="round" fill="clear" strong="true" class="ion-no-margin" (click)="incrementMonth()" aria-label="Next Month" [disabled]="isNextMonth()">
            <ion-icon slot="icon-only" name="chevron-forward" aria-label="Previous Month"></ion-icon>
          </ion-button>
          <ion-button color="tertiary" shape="round" fill="clear" strong="true" class="ion-no-margin" (click)="incrementYear()" aria-label="Next year" [disabled]="!isNextYear()">
            <img src="../../../assets/icon/right_arrows.svg" alt="Next" width="30" height="30">
          </ion-button>
        </ion-buttons>
      </ion-item>
    </ion-list>

    
    <ion-card class="calendar_card">
      <ion-card-content>
        <table>
          <thead>
            <tr>
              <th *ngFor="let day of ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat']">{{ day }}</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let week of dates">
              <td *ngFor="let date of week">
                <span [ngClass]="getStatusByDate(date ?? '') ? getStatusByDate(date ?? '')?.status : ''">{{ date ? getMomentDate(date) : '' }}</span>
              </td>
            </tr>
          </tbody>
        </table>
      </ion-card-content>
    </ion-card>
    <ion-grid>
      <ion-row>
        <ion-col size="6" sizeSm="4">
          <circular-progress-bar [value]="getPresent" [maxValue]="getLastDate" color="var(--ion-color-success)"></circular-progress-bar>
          <ion-item lines="none" [detail]="false" color="light">
            <ion-label class="ion-text-center">Present</ion-label>
          </ion-item>
        </ion-col>
        <ion-col size="6" sizeSm="4">
          <circular-progress-bar [value]="getAbsent + getLeaves" [maxValue]="getLastDate" color="var(--ion-color-danger)"></circular-progress-bar>
          <ion-item lines="none" [detail]="false" color="light">
            <ion-label class="ion-text-center">Absent</ion-label>
          </ion-item>
        </ion-col>
      </ion-row>
    </ion-grid>
  </div>

    <!-- ------------ attendance list ----------------- -->
    <div class="attendance_list" [hidden]="!employee || showCalendar">
      <ion-list [inset]="true" mode="ios">
        <ion-item lines="none" class="item1" [detail]="true" color="primary" type="button" [button]="true" [mode]="'ios'" (click)="dateModal = true" detailIcon="chevron-down">
          <ion-icon [name]="'calendar'" slot="start"></ion-icon>
          <ion-label class="ion-text-wrap">
            <h2>Attendance of the month</h2>
            <p>{{getMonthYear().trim() != '' ? getMonthYear() : 'Select Month'}}</p>
          </ion-label>
        </ion-item>
      </ion-list>
      <!-- <ion-grid style="background-color: #fff;">
        <ion-row>
          <ion-col size="12">
          </ion-col>
          <ion-col class="ion-text-center" size="6">
            <ion-card mode="ios" [color]="'success'" class="statusCard">
              <ion-card-header>
                <ion-text>days</ion-text>
                <ion-card-title>{{presents}}<small>/{{getLastDate}}</small></ion-card-title>
                <ion-card-subtitle>Present</ion-card-subtitle>
              </ion-card-header>
            </ion-card>
          </ion-col>
          <ion-col class="ion-text-center" size="6">
            <ion-card mode="ios" [color]="'danger'" class="statusCard">
              <ion-card-header>
                <ion-text>days</ion-text>
                <ion-card-title>{{absent}}<small>/{{getLastDate}}</small></ion-card-title>
                <ion-card-subtitle>Absent</ion-card-subtitle>
              </ion-card-header>
            </ion-card>
          </ion-col>
        </ion-row>
      </ion-grid> -->
      <ion-list [inset]="true" mode="ios">
        <ion-item>
          <ion-icon color="success" slot="start" name="list-circle" size="large"></ion-icon>
          <ion-label>Present</ion-label>
          <ion-note slot="end">{{getPresent}}/{{getLastDate}}</ion-note>
        </ion-item>
        <ion-item>
          <ion-icon color="danger" slot="start" name="list-circle" size="large"></ion-icon>
          <ion-label>Absent</ion-label>
          <ion-note slot="end">{{getAbsent}}/{{getLastDate}}</ion-note>
        </ion-item>
      </ion-list>

      <ng-container *ngFor="let item of dateList; index as a;">
        <ion-card mode="md" class="cardItem {{isAllLoaded() ? item.status : ''}}">
          <ion-card-header (click)="toggleCard(item)" *ngIf="isAllLoaded()">
            <div>
              <ion-card-title>{{item.created_date | date:'EEEE, dd MMM'}}</ion-card-title>
              <ion-card-subtitle>{{item.status}}</ion-card-subtitle>
            </div>
            
            <ion-button [shape]="'round'" [mode]="'ios'" [size]="'small'" [fill]="'clear'" [color]="'medium'" *ngIf="item.attendanceData != null || item.leaveData != null" class="expandBtn">
              <ion-icon [name]="item.open_form ? 'chevron-up-outline' : 'chevron-down-outline'" slot="icon-only" [size]="'small'"></ion-icon>
            </ion-button>

            <ion-chip color="tertiary" *ngIf="!isWeekOff(item.created_date) && item.status === 'Absent'" (click)="markPresent($event, item)" class="ion-no-margin ion-text-center btnChip">Make Present</ion-chip>
          </ion-card-header>
          <ion-card-content *ngIf="item.open_form && isAllLoaded()">
            <ion-row class="sort_desc ion-margin-top" *ngIf="item.attendanceData != null">
              <ion-col size="6">
                <ion-text>In Time</ion-text>
              </ion-col>
              <ion-col size="6">
                <ion-label>{{item.attendanceData.clockIn | date:'mediumTime'}}</ion-label>
              </ion-col>
              <ion-col size="6">
                <ion-text>Out Time</ion-text>
              </ion-col>
              <ion-col size="6">
                <ion-label *ngIf="!item.attendanceData.clockOut">--</ion-label>
                <ion-label *ngIf="item.attendanceData.clockOut">{{item.attendanceData.clockOut | date:'mediumTime'}}</ion-label>
              </ion-col>
              <ion-col size="6">
                <ion-text>Work Duration <small>(HH:MM:SS)</small></ion-text>
              </ion-col>
              <ion-col size="6">
                <ion-label>{{item.attendanceData.workingTime ? item.attendanceData.workingTime.slice(0, 7) : '--'}}</ion-label>
              </ion-col>
            </ion-row>
            <div *ngIf="item.leaveData != null">
              <!-- <ion-chip color="tertiary" class="ion-margin-top">
                <ion-icon name="calendar" size="small"></ion-icon>
                <ion-label>{{item.leaveData.startDate | date}} - {{item.leaveData.endDate | date}}</ion-label>
              </ion-chip> -->
              <div class="ion-margin-top leaveDate">
                <ion-label color="tertiary" class="ion-text-wrap">
                  <ion-icon name="calendar" size="small"></ion-icon>
                  <ion-label>{{item.leaveData.startDate | date}} - {{item.leaveData.endDate | date}}</ion-label>
                </ion-label>
              </div>
              <p>
                <b><ion-text>{{item.leaveData.leaveType}}</ion-text></b> &middot; {{item.leaveData.dayType}}
              </p>
              <p class="purpose">
                <read-more-text [textString]="item.leaveData.purpose" [maxLength]="100"></read-more-text>
              </p>
              <div class="ion-text-end">
                <ion-chip [color]="item.leaveData.status === 'Accept' ? 'success' : item.leaveData.status === 'Pending' ? 'warning' : 'danger' ">
                  {{item.leaveData.status === 'Accept' ? 'Accepted' : item.leaveData.status === 'Pending' ? 'Pending' : item.leaveData.status === 'Reject' ? 'Rejected' : item.leaveData.status}}
                </ion-chip>
              </div>
            </div>
          </ion-card-content>
          <ion-skeleton-text style="width: 100%; height: 80px;" animated="true" class="inherit_shap ion-no-margin" *ngIf="!isAllLoaded()"></ion-skeleton-text>
        </ion-card>
      </ng-container>

      <div class="ion-text-center" [hidden]="attendanceLoaded">
        <ion-spinner [name]="'circular'" color="primary"></ion-spinner>
      </div>
    </div>
    
    <ion-infinite-scroll #infiniteScroll (ionInfinite)="moreAttendance ? loadData($any($event)) : ''" [position]="'bottom'" *ngIf="employee">
      <ion-infinite-scroll-content *ngIf="moreAttendance" loadingSpinner="circular" loadingText="Loading more data...">
      </ion-infinite-scroll-content>
    </ion-infinite-scroll>
</ion-content>
