<ion-header [translucent]="true" mode="md">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button mode="md" fill="clear" [routerDirection]="'back'" (click)="goBack()" class="noBg noRipple">
        <ion-icon name="chevron-back-outline" aria-hidden="true" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title>Attendance</ion-title>
    <!-- <ion-thumbnail slot="end" class="logo_img ion-margin-end">
      <ion-img src="../../../assets/icon/hr-atlas_logo_2.png" alt="HR-Atlas"></ion-img>
    </ion-thumbnail> -->
    <div slot="end" class="ion-margin-end toggleview">
      <ion-button type="button" [fill]="showCalendar ? 'clear' : 'solid'" shape="round" mode="ios" color="tertiary" size="small" aria-label="List View" (click)="showCalendar = !showCalendar">
        <ion-icon aria-hidden="true" size="small" slot="icon-only" name="list"></ion-icon>
      </ion-button>
      <ion-button type="button" [fill]="!showCalendar ? 'clear' : 'solid'" shape="round" mode="ios" color="tertiary" size="small" aria-label="Calendar View" (click)="showCalendar = !showCalendar">
        <ion-icon aria-hidden="true" size="small" slot="icon-only" name="calendar"></ion-icon>
      </ion-button>
    </div>
    <ion-progress-bar type="indeterminate" *ngIf="!dataLoaded"></ion-progress-bar>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" color="light">
  <ion-refresher slot="fixed" (ionRefresh)="handleRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>
  <!-- <div class="flex_div_2" *ngIf="!dataLoaded">
    <div class="loader_img">
      <img src="../../../assets/icon/hr-atlas-150x80.png" alt="HR-Atlas">
    </div>
    <ion-spinner [color]="'tertiary'"></ion-spinner>
  </div> -->
  <div class="container">
    <!-- ------------ attendance list ----------------- -->
    <div class="attendance_list" *ngIf="!showCalendar">
      <ion-list mode="ios" [inset]="true">
        <ion-item type="button" detailIcon="pencil" [detail]="true" (click)="dateModal = !dateModal" color="tertiary" class="dateBtn">
          <ion-icon name="calendar" [slot]="'start'"></ion-icon>
          <ion-label class="ion-text-wrap">
            <h2>Month Attendance</h2>
            <p>{{getMonthYear().trim() != '' ? getMonthYear() : 'Select Month'}}</p>
          </ion-label>
        </ion-item>
      </ion-list>
      <ion-modal [isOpen]="dateModal" [initialBreakpoint]="0.5" mode="md" [showBackdrop]="true" (didDismiss)="dateModal = false">
        <ng-template>
          <ion-content color="light">
            <ion-datetime color="primary" presentation="month-year" size="cover" [(ngModel)]="attendanceDate" mode="md" [max]="today.toISOString()" [min]="minDate.toISOString()" #yearMonth (ionChange)="selectDate($any($event));">
              <ion-label slot="title">Select Year and Month</ion-label>
              <ion-buttons slot="buttons">
                <ion-button mode="md" color="danger" (click)="yearMonth.cancel(); dateModal = false;">Cancel</ion-button>
                <ion-button mode="md" color="primary" [disabled]="!attendanceDate" (click)="yearMonth.confirm(); dateModal = false;">Done</ion-button>
              </ion-buttons>
            </ion-datetime>
          </ion-content>
        </ng-template>
      </ion-modal>

      <ng-container *ngFor="let item of dateList; index as a;">
        <ion-card [mode]="'md'" class="cardItem {{item.status}}">
          <ion-card-header (click)="toggleCard(item)">
            <div>
              <ion-card-title>{{item.created_date | date:'EEEE, dd MMM'}}</ion-card-title>
              <ion-card-subtitle>{{item.status}}</ion-card-subtitle>
            </div>
            
            <ion-button [shape]="'round'" [mode]="'ios'" [size]="'small'" [fill]="'clear'" [color]="'medium'" *ngIf="item.attendanceData != null || item.leaveData != null" class="expandBtn">
              <ion-icon [name]="item.open_form ? 'chevron-up-outline' : 'chevron-down-outline'" slot="icon-only" [size]="'small'"></ion-icon>
            </ion-button>
          </ion-card-header>
          <ion-card-content *ngIf="item.open_form">
            <ion-row class="sort_desc ion-margin-top" *ngIf="item.attendanceData != null">
              <ion-col size="6">
                <ion-text>In Time</ion-text>
              </ion-col>
              <ion-col size="6">
                <ion-label>{{item.attendanceData.clockIn | date:'mediumTime'}}</ion-label>
              </ion-col>
              <ion-col size="6">
                <ion-text>Out Time</ion-text>
              </ion-col>
              <ion-col size="6">
                <ion-label *ngIf="!item.attendanceData.clockOut">--</ion-label>
                <ion-label *ngIf="item.attendanceData.clockOut">{{item.attendanceData.clockOut | date:'mediumTime'}}</ion-label>
              </ion-col>
              <ion-col size="6">
                <ion-text>Work Duration <small>(HH:MM:SS)</small></ion-text>
              </ion-col>
              <ion-col size="6">
                <ion-label>{{item.attendanceData.workingTime ? item.attendanceData.workingTime.slice(0, 7) : '--'}}</ion-label>
              </ion-col>
            </ion-row>
            <div class="sort_desc ion-margin-top" *ngIf="item.leaveData != null">
              <div class="leaveDate">
                <ion-label color="tertiary" class="ion-text-wrap">
                  <ion-icon name="calendar" size="small"></ion-icon>
                  <ion-label>{{item.leaveData.startDate | date}} - {{item.leaveData.endDate | date}}</ion-label>
                </ion-label>
              </div>
              <p>
                <b><ion-text>{{item.leaveData.leaveType}}</ion-text></b> &middot; {{item.leaveData.dayType}}
              </p>
              <p class="purpose">
                <read-more-text [textString]="item.leaveData.purpose" [maxLength]="100"></read-more-text>
              </p>
              <div class="ion-text-end">
                <ion-chip [color]="item.leaveData.status === 'Accept' ? 'success' : item.leaveData.status === 'Pending' ? 'warning' : 'danger' ">
                  {{item.leaveData.status === 'Accept' ? 'Accepted' : item.leaveData.status === 'Pending' ? 'Pending' : item.leaveData.status === 'Reject' ? 'Rejected' : item.leaveData.status}}
                </ion-chip>
              </div>
            </div>
          </ion-card-content>
        </ion-card>
      </ng-container>
    </div>

    <div class="calenderView" *ngIf="showCalendar">

      <ion-list inset="true" mode="ios">
        <ion-item detail="false" class="calendarControls">
          <ion-buttons slot="start">
            <ion-button color="tertiary" shape="round" fill="clear" strong="true" class="ion-no-margin" (click)="decrementYear()" aria-label="Previous Month">
              <img src="../../../assets/icon/left_arrows.svg" alt="Previous" width="30" height="30">
            </ion-button>
            <ion-button color="tertiary" shape="round" fill="clear" strong="true" class="ion-no-margin" (click)="decrementMonth()" aria-label="Next Year">
              <ion-icon slot="icon-only" name="chevron-back" aria-label="Previous Month"></ion-icon>
            </ion-button>
          </ion-buttons>
          <ion-label class="ion-text-center">{{ attendanceDate | date:"MMMM yyyy" }}</ion-label>
          <ion-buttons slot="end">
            <ion-button color="tertiary" shape="round" fill="clear" strong="true" class="ion-no-margin" (click)="incrementMonth()" aria-label="Next Month" [disabled]="isNextMonth()">
              <ion-icon slot="icon-only" name="chevron-forward" aria-label="Previous Month"></ion-icon>
            </ion-button>
            <ion-button color="tertiary" shape="round" fill="clear" strong="true" class="ion-no-margin" (click)="incrementYear()" aria-label="Next year" [disabled]="!isNextYear()">
              <img src="../../../assets/icon/right_arrows.svg" alt="Next" width="30" height="30">
            </ion-button>
          </ion-buttons>
        </ion-item>
      </ion-list>
      
      <ion-card class="calendar_card">
        <ion-card-content>
          <table>
            <thead>
              <tr>
                <th *ngFor="let day of ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat']">{{ day }}</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let week of dates">
                <td *ngFor="let date of week">
                  <span [ngClass]="getStatusByDate(date ?? '') ? getStatusByDate(date ?? '')?.status : ''">{{ date ? getMomentDate(date) : '' }}</span>
                </td>
              </tr>
            </tbody>
          </table>
        </ion-card-content>
      </ion-card>
      <!-- <ion-datetime presentation="date" size="cover" mode="md" [(ngModel)]="attendanceDate" [max]="today.toISOString()" class="attendance_calendar" [highlightedDates]="highlightedDates" (ionChange)="selectDate($any($event))"></ion-datetime> -->
    </div>
  </div>
</ion-content>
